#!/bin/bash

#http://stackoverflow.com/a/16496491/1047804

PSOF_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"


PSOF_DEFAULT_PROJECT_VERSION="1.0.0"
PSOF_DEFAULT_PROJECT_APPLICATION_LANGUAGE="java"
PSOF_DEFAULT_PROJECT_DATABASE_DRIVER="mysql"
PSOF_DEFAULT_PROJECT_DATABASE_HOST="localhost"
PSOF_DEFAULT_PROJECT_DATABASE_PORT="3306"
PSOF_DEFAULT_PROJECT_DATABASE_NAME="hello"
PSOF_DEFAULT_PROJECT_DATABASE_USERNAME="tmp_todo"
PSOF_DEFAULT_PROJECT_DATABASE_PASSWORD="cd89a9"
PSOF_DEFAULT_PROJECT_DATABASE_VERSION="1.0.0"

create_psof_xml() {
    sed -e "s/\${PSOF_PROJECT_NAME}/${PSOF_PROJECT_NAME}/" \
    -e "s/\${PSOF_PROJECT_VERSION}/${PSOF_PROJECT_VERSION}/" \
    -e "s/\${PSOF_PROJECT_APPLICATION_LANGUAGE}/${PSOF_PROJECT_APPLICATION_LANGUAGE}/" \
    -e "s/\${PSOF_PROJECT_DATABASE_DRIVER}/${PSOF_PROJECT_DATABASE_DRIVER}/" \
    -e "s/\${PSOF_PROJECT_DATABASE_HOST}/${PSOF_PROJECT_DATABASE_HOST}/" \
    -e "s/\${PSOF_PROJECT_DATABASE_PORT}/${PSOF_PROJECT_DATABASE_PORT}/" \
    -e "s/\${PSOF_PROJECT_DATABASE_NAME}/${PSOF_PROJECT_DATABASE_NAME}/" \
    -e "s/\${PSOF_PROJECT_DATABASE_VERSION}/${PSOF_PROJECT_DATABASE_VERSION}/" \
    -e "s/\${PSOF_PROJECT_DATABASE_USERNAME}/${PSOF_PROJECT_DATABASE_USERNAME}/" \
    -e "s/\${PSOF_PROJECT_DATABASE_PASSWORD}/${PSOF_PROJECT_DATABASE_PASSWORD}/" -i $PWD/$1/psof.xml
}

#PSOF_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"


create_dirs() { 
    cp -r ${PSOF_DIR}/template $PWD/$1
}

create_initial_db() { 
    sed -e "s/\${PSOF_PROJECT_DATABASE_NAME}/${PSOF_PROJECT_NAME}/" \
    -e "s/\${PSOF_PROJECT_DATABASE_VERSION}/${PSOF_PROJECT_DATABASE_VERSION}/" -i $PWD/$1/db/diff/0.0.0_to_1.0.0.sql
    mysql -h${DB_HOST} -u${DB_USERNAME} -p${DB_PASSWORD} < $PWD/$1/db/diff/0.0.0_to_1.0.0.sql
    #get current db version
}

create_initial_app() { 
    sed -e "s/\${PSOF_PROJECT_NAME}/${PSOF_PROJECT_NAME}/" \
    -e "s/\${PSOF_PROJECT_VERSION}/${PSOF_PROJECT_VERSION}/" -i $PWD/$1/app/pom.xml
    git init $PWD/$1
}


echo Creating new project...
create_dirs "$@"

echo $1
if [ -z "$1" ]; then
    echo "Project name not set"; exit 1;
else
    PSOF_PROJECT_NAME=$1
fi

if [ -z ${PSOF_PROJECT_VERSION+x} ]; then
    PSOF_PROJECT_VERSION=${PSOF_DEFAULT_PROJECT_VERSION}; 
fi

if [ -z ${PSOF_PROJECT_APPLICATION_LANGUAGE+x} ]; then
    PSOF_PROJECT_APPLICATION_LANGUAGE=${PSOF_DEFAULT_PROJECT_APPLICATION_LANGUAGE}; 
fi

if [ -z ${PSOF_PROJECT_DATABASE_DRIVER+x} ]; then
    PSOF_PROJECT_DATABASE_DRIVER=${PSOF_DEFAULT_PROJECT_DATABASE_DRIVER}; 
fi

if [ -z ${PSOF_PROJECT_DATABASE_HOST+x} ]; then
    PSOF_PROJECT_DATABASE_HOST=${PSOF_DEFAULT_PROJECT_DATABASE_HOST}; 
fi

if [ -z ${PSOF_PROJECT_DATABASE_PORT+x} ]; then
    PSOF_PROJECT_DATABASE_PORT=${PSOF_DEFAULT_PROJECT_DATABASE_PORT}; 
fi

if [ -z ${PSOF_PROJECT_DATABASE_NAME+x} ]; then
    PSOF_PROJECT_DATABASE_NAME=${PSOF_DEFAULT_PROJECT_DATABASE_NAME}; 
fi

if [ -z ${PSOF_PROJECT_DATABASE_USERNAME+x} ]; then
    PSOF_PROJECT_DATABASE_USERNAME=${PSOF_DEFAULT_PROJECT_DATABASE_USERNAME}; 
fi

if [ -z ${PSOF_PROJECT_DATABASE_PASSWORD+x} ]; then
    PSOF_PROJECT_DATABASE_PASSWORD=${PSOF_DEFAULT_PROJECT_DATABASE_PASSWORD}; 
fi

if [ -z ${PSOF_PROJECT_DATABASE_VERSION+x} ]; then
    PSOF_PROJECT_DATABASE_VERSION=${PSOF_DEFAULT_PROJECT_DATABASE_VERSION}; 
fi

create_psof_xml "$@"
source ${PSOF_DIR}/psof_config $PWD/$1/psof.xml
create_initial_db "$@"
create_initial_app "$@"
echo OK
